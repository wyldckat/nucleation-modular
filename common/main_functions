#!/bin/bash

#-- MAIN FUNCTIONS ------------------------------------------------------
#list of functions herein:

#global variables used by this script:


#Code -----------------------------------------
echo "Sourcing Main functions..."

#source system related script
if [ "x$INST_SYSTEM" != "x" -a "x${SCRIPT_WORKFOLDER}" != "x" ]; then
  . ${SCRIPT_WORKFOLDER}/common/${INST_SYSTEM}/main_functions
else
  echo "The variable INST_SYSTEM and/or SCRIPT_WORKFOLDER is/are empty and they are crucial to exist! Aborting execution."
  exit 1
fi


#FUNCTIONS ------------------------------------------------------------------------------

#Define files (including paths) to the files this script provides
function define_script_s_files()
{
  #Define files (including paths) to the files this script provides for common/$system
  define_script_s_files_system

  #Define files (including paths) to the files this script provides for of$OF_SHORT_VERSION
  define_script_s_files_ofv

  #Repository paraview -> upgraded paraFoam script
  if [ "x$USE_REPO_PV" == "xon" -o "x$USE_KITWARE_PV" == "xon" ]; then
    PFOAM_PATCHFILE[0]="paraFoamSys"
    PFOAM_PATCHFILE[1]="${SCRIPT_WORKFOLDER}/common/files/${PFOAM_PATCHFILE[0]}"
  fi

  #patch file for tweaking timing option into wmake
  WMAKEPATCHFILE[0]="patchWmake"
  WMAKEPATCHFILE[1]="${SCRIPT_WORKFOLDER}/common/files/${WMAKEPATCHFILE[0]}"
}


function define_default_user_options()
{
  LOG_OUTPUTS=Yes             #Yes | No
  INSTALLMODE=fresh           #fresh | update | server | custom
  CUSTOMOPTS_OFOPTIONALS=off  #on | off
  CUSTOMOPTS_PARAVIEW=off     #on | off

  BUILD_DOCUMENTATION=off     #on | off
  USE_ALIAS_FOR_BASHRC=off    #on | off
  USE_OF_GCC=off              #on | off
  BUILD_CCM26TOFOAM=off       #on | off
  USE_REPO_PV=off             #on | off
  USE_KITWARE_PV=off          #on | off

  BUILD_QT=off                   #on | off
  BUILD_PARAVIEW=off             #on | off
  BUILD_PARAVIEW_WITH_GUI=on     #on | off
  BUILD_PARAVIEW_WITH_PYTHON=off #on | off
  BUILD_PARAVIEW_WITH_MPI=off    #on | off
  BUILD_PARAVIEW_WITH_OSMESA=off #on | off

  BUILD_GCC=off               #on | off
  BUILD_GCC_STRICT_64BIT=off  #on | off

  #findClosest | optusnet | ufpr | nchc | mesh | garr | jaist | puzzle | kent | internap
  mirror=mesh

  #define default options that are system dependent
  define_default_user_options_system
}

#git clone OpenFOAM
function OpenFOAM_git_clone()
{
  cd_openfoam #this is a precautionary measure

  echo "------------------------------------------------------"
  echo "Retrieving OpenFOAM $OF_LONG_VERSION from git..."
  echo "------------------------------------------------------"
  git clone ${OPENFOAM_GIT_REPO}
  OpenFOAM_git_error=$?

  continue_after_failed_openfoam_git
}

#apply patches and fixes
function apply_patches_fixes()
{
  #apply patches (depends on the version of OpenFOAM)
  apply_patches

  #apply_fixes (also depends on the version of OpenFOAM)
  apply_fixes
}

#Activate OpenFOAM environment
function setOpenFOAMEnv()
{
  echo "------------------------------------------------------"
  echo "Activate OpenFOAM environment"
  echo "------------------------------------------------------"
  cd_openfoam
  cd OpenFOAM-$OF_LONG_VERSION/
  . $PATHOF/OpenFOAM-$OF_LONG_VERSION/etc/bashrc
}

#Add OpenFOAM's bashrc entry in $PATHOF/.bashrc
function add_openfoam_to_bashrc()
{
  echo "------------------------------------------------------"
  echo "Add OpenFOAM's bashrc entry in $PATHOF/.bashrc"
  echo "------------------------------------------------------"

  #nuke ~/.bashrc entries that have references to the same script
  grep -v "$PATHOF/OpenFOAM-$OF_LONG_VERSION/etc/bashrc" ~/.bashrc > ~/.bashrc.new
  cp ~/.bashrc ~/.bashrc.old
  mv ~/.bashrc.new ~/.bashrc
  if [ "x$USE_ALIAS_FOR_BASHRC" == "xon" ]; then
    echo -e "alias startFoam$OF_SHORT_VERSION=\". $PATHOF/OpenFOAM-$OF_LONG_VERSION/etc/bashrc\"" >> ~/.bashrc
  else
    echo ". $PATHOF/OpenFOAM-$OF_LONG_VERSION/etc/bashrc" >> ~/.bashrc
  fi
}

#provide the user with a progress bar and timings for building gcc
function build_gcc_progress_dialog()
{
  if [ "x$BUILD_GCC_MUST_KILL" == "xYes" ]; then

    echo -e "\n\nKill code issued... please wait..."
    echo -e "NOTE: The kill code will take a few seconds to affect all child processes."
    killgroup $BUILD_GCC_PID

  else

    ( #while true is used as a containment cycle...
    while : ;
    do
      if [ -e "$BUILD_GCC_LOG" ]; then
        BUILD_GCC_MAKECOUNT=`grep 'make\[.\]' "$BUILD_GCC_LOG" | wc -l`
        nowpercent=`expr $BUILD_GCC_MAKECOUNT \* 100 / $BUILD_GCC_LAST_BUILD_COUNT`
      fi
      if [ "x$nowpercent" != "x$percent" ]; then
        percent=$nowpercent
        BUILD_GCC_UPDATE_TIME=`date`
      fi
      echo $percent
      echo "XXX"
      echo "Build gcc-$GCC_VERSION:"
      echo "The build process is going to be logged in the file:"
      echo "  $BUILD_GCC_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $BUILD_GCC_LOG"
      echo "Either way, please wait, this will take a while..."
      echo -e "\nQt started to build at:\n\t$BUILD_GCC_START_TIME\n"
      echo -e "Last progress update made at:\n\t$BUILD_GCC_UPDATE_TIME"
      echo "XXX"

      #this provides a better monitorization of the process itself... i.e., if it has already stopped!
      #30 second update
      monitor_sleep $BUILD_GCC_PID 30

      if ! ps -p $BUILD_GCC_PID > /dev/null; then
        break;
      fi
    done
    ) | dialog --backtitle "$GUI_BACKTITLE" \
        --title "Building gcc" --gauge "Starting..." 20 80 $percent >&4
  fi

  #monitor here too, to wait for kill code, when issued
  monitor_sleep $BUILD_GCC_PID 30
}

#this indicates to the user that we have it under control...
function build_gcc_ctrl_c_triggered()
{
  BUILD_GCC_MUST_KILL="Yes"
  build_gcc_progress_dialog
}

#build gcc that comes with OpenFOAM
function build_openfoam_gcc()
{
  if [ "x$BUILD_GCC" == "xon" ]; then

    #set up environment, just in case we forget about it!
    if [ "x$WM_PROJECT_DIR" == "x" ]; then
      setOpenFOAMEnv
    fi

    cd $WM_THIRD_PARTY_DIR

    #gcc root changes with OpenFOAM versions...
    set_BUILD_GCC_ROOT

    #purge existing gcc
    if [ -e "$BUILD_GCC_ROOT" ]; then
      rm -rf $BUILD_GCC_ROOT
    fi

    if [ "x$BUILD_GCC_STRICT_64BIT" == "xon" ]; then
      BUILD_GCC_OPTION="--disable-multilib"
    fi

    BUILD_GCC_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/build_gcc.log"

    #set up traps...
    trap build_gcc_ctrl_c_triggered SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build gcc:"

    #launch makeGcc asynchronously
    bash -c "time ./${GCCMODED_MAKESCRIPT[0]} $BUILD_GCC_OPTION" > "$BUILD_GCC_LOG" 2>&1 &
    BUILD_GCC_PID=$!
    BUILD_GCC_START_TIME=`date`
    BUILD_GCC_UPDATE_TIME=$BUILD_GCC_START_TIME

    #track build progress
    percent=0
    build_gcc_progress_dialog

    #wait for kill code to change
    clear
    if ! ps -p $BUILD_GCC_PID > /dev/null && [ "x$BUILD_GCC_MUST_KILL" != "x" ]; then
      echo "Kill code issued with success. The script will continue execution."
    fi

    #clear traps
    trap - SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build gcc-$GCC_VERSION:"
    if [ -e "$BUILD_GCC_ROOT/bin/gcc" ]; then
      echo -e "gcc started to build at:\n\t$BUILD_GCC_START_TIME\n"
      echo -e "Building gcc finished successfully at:\n\t`date`"
      echo "gcc is ready to be used."

      #sometimes it's necessary to do some additional fixing to the custom built gcc
      fix_gcc_if_necessary
    else
      echo "Build process didn't finished with success. Please check the log file for more information:"
      echo -e "\t$BUILD_GCC_LOG"
      echo "You can post it at this forum thread:"
      echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
      echo -e '\nYou can also verify that thread for other people who might have had the same problems.'
      BUILD_GCC_FAILED="Yes"
    fi
    echo "------------------------------------------------------"

  fi
}

#provide the user with a progress bar and timings for building OpenFOAM
function build_awopenfoam_progress_dialog()
{
  if [ "x$BUILD_AWOPENFOAM_MUST_KILL" == "xYes" ]; then
    echo -e "\n\nKill code issued... please wait..."
    echo -e "NOTE: The kill code will take a few seconds to affect all child processes."
    killgroup $BUILD_AWOPENFOAM_PID

  else

    ( #while true is used as a containment cycle...
    while : ;
    do
      if [ -e "$BUILD_AWOPENFOAM_LOG" ]; then
        BUILD_AWOPENFOAM_MAKECOUNT=`grep 'WMAKE timing start' "$BUILD_AWOPENFOAM_LOG" | wc -l`
        nowpercent=`expr $BUILD_AWOPENFOAM_MAKECOUNT \* 100 / $BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT`
      fi

      if [ "x$nowpercent" != "x$percent" ]; then
        percent=$nowpercent
        BUILD_AWOPENFOAM_UPDATE_TIME=`date`
      fi
      echo $percent
      echo "XXX"
      echo "Build OpenFOAM:"
      echo "The Allwmake build process is going to be logged in the file:"
      echo "  $BUILD_AWOPENFOAM_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $BUILD_AWOPENFOAM_LOG"
      echo "WARNING: THIS CAN TAKE HOURS..."
      echo -e "\nAllwmake started to build at:\n\t$BUILD_AWOPENFOAM_START_TIME"
      echo -e "\nLast progress update made at:\n\t$BUILD_AWOPENFOAM_UPDATE_TIME"
      echo "XXX"

      #this provides a better monitorization of the process itself... i.e., if it has already stopped!
      #30 second update
      monitor_sleep $BUILD_AWOPENFOAM_PID 30

      if ! ps -p $BUILD_AWOPENFOAM_PID > /dev/null; then
        break;
      fi
    done
    ) | dialog --backtitle "$GUI_BACKTITLE" \
        --title "Building OpenFOAM" --gauge "Starting..." 20 80 $percent >&4
  fi

  #monitor here too, to wait for kill code, when issued
  monitor_sleep $BUILD_AWOPENFOAM_PID 30
}

#this indicates to the user that we have it under control...
function build_awopenfoam_ctrl_c_triggered()
{
  BUILD_AWOPENFOAM_MUST_KILL="Yes"
  build_awopenfoam_progress_dialog
}

#do an Allwmake on OpenFOAM
function allwmake_openfoam()
{
  #set up environment, just in case we forget about it!
  if [ "x$WM_PROJECT_DIR" == "x" ]; then
    setOpenFOAMEnv
  fi

  cd $WM_PROJECT_DIR
  BUILD_AWOPENFOAM_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/make.log"

  #set up traps...
  trap build_awopenfoam_ctrl_c_triggered SIGINT SIGQUIT SIGTERM

  export WM_DO_TIMINGS="Yes"

  echo "------------------------------------------------------"
  echo "Build OpenFOAM:"
  echo "Calculating building estimates, please wait..."
  #wmake is called once for each Make folder and for each Allwmake
  BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT1=`find ${WM_PROJECT_DIR}/* | grep -v "/applications/test" | grep -v "/Optional" | grep -v "/doc/" | grep -e "Make/files" -e "Allwmake" | wc -l`
  BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT2=`find ${WM_THIRD_PARTY_DIR}/* | grep -e "Make/options" -e "Allwmake" | wc -l`
  #wmake count should also include the first call... and at least 1 more just in case...
  BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT=`expr $BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT1 + $BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT2 + 2`
  unset BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT1 BUILD_AWOPENFOAM_ESTIM_BUILD_COUNT2
  echo "------------------------------------------------------"

  #launch wmake all asynchronously
  #bash -c is the only way I got for getting time results straight to display and also logged
  bash -c "time wmake all > ${BUILD_AWOPENFOAM_LOG} 2>&1" >> ${BUILD_AWOPENFOAM_LOG} 2>&1 &
  BUILD_AWOPENFOAM_PID=$!
  BUILD_AWOPENFOAM_START_TIME=`date`
  BUILD_AWOPENFOAM_UPDATE_TIME=$BUILD_AWOPENFOAM_START_TIME

  #track build progress
  percent=0
  build_awopenfoam_progress_dialog

  #wait for kill code to change
  clear
  if ! ps -p $BUILD_AWOPENFOAM_PID > /dev/null && [ "x$BUILD_AWOPENFOAM_MUST_KILL" != "x" ]; then
    echo "Kill code issued with success. The script will continue execution."
  fi

  #clear traps
  trap - SIGINT SIGQUIT SIGTERM

  export WM_DO_TIMINGS=
  echo "------------------------------------------------------"
  echo "Build OpenFOAM:"
  echo -e "Allwmake started to build at:\n\t$BUILD_AWOPENFOAM_START_TIME\n"
  echo -e "Allwmake finished at:\n\t`date`"
  echo "------------------------------------------------------"
}

#provide the user with a progress bar and timings for building OpenFOAM
function build_awopenfoam_docs_progress_dialog()
{
  if [ "x$BUILD_AWOPENFOAM_MUST_KILL" == "xYes" ]; then
    echo -e "\n\nKill code issued... please wait..."
    echo -e "NOTE: The kill code will take a few seconds to affect all child processes."
    killgroup $BUILD_AWOPENFOAM_PID

  else

    ( #while true is used as a containment cycle...
    while : ;
    do
      if [ -e "$BUILD_AWOPENFOAMDOC_LOG" ]; then
        BUILD_AWOPENFOAM_NOWCOUNT=`cat "$BUILD_AWOPENFOAMDOC_LOG" | grep -e "^Parsing file" -e "^Generating code for file" -e "^Generating docs for" -e "^Generating dependency graph for directory" | wc -l`
        nowpercent=`expr $BUILD_AWOPENFOAM_NOWCOUNT \* 100 / $BUILD_AWOPENFOAMDOC_ESTIMCOUNT`
      fi

      if [ "x$nowpercent" != "x$percent" ]; then
        percent=$nowpercent
        BUILD_AWOPENFOAM_UPDATE_TIME=`date`
      fi

      echo $percent
      echo "XXX"
      echo "Build OpenFOAM documentation:"
      echo "The Doxygen build process is going to be logged in the file:"
      echo "  $BUILD_AWOPENFOAMDOC_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $BUILD_AWOPENFOAMDOC_LOG"
      echo "WARNING: THIS CAN TAKE HOURS..."
      echo -e "Doxygen started to build OpenFOAM code documentation at:\n\t$BUILD_AWOPENFOAMDOC_START_TIME"
      echo -e "\nLast progress update made at:\n\t$BUILD_AWOPENFOAM_UPDATE_TIME"
      echo "XXX"

      #this provides a better monitorization of the process itself... i.e., if it has already stopped!
      #30 second update
      monitor_sleep $BUILD_AWOPENFOAM_PID 30

      if ! ps -p $BUILD_AWOPENFOAM_PID > /dev/null; then
        break;
      fi
    done
    ) | dialog --backtitle "$GUI_BACKTITLE" \
        --title "Building OpenFOAM" --gauge "Starting..." 24 80 $percent >&4
  fi

  #monitor here too, to wait for kill code, when issued
  monitor_sleep $BUILD_AWOPENFOAM_PID 30
}

#this indicates to the user that we have it under control...
function build_awopenfoam_docs_ctrl_c_triggered()
{
  BUILD_AWOPENFOAM_MUST_KILL="Yes"
  build_awopenfoam_docs_progress_dialog
}

#do an "wmake all docs" on OpenFOAM
function allwmake_openfoam_docs()
{
  if [ "x$BUILD_DOCUMENTATION" == "xon" ]; then

    #set up environment, just in case we forget about it!
    if [ "x$WM_PROJECT_DIR" == "x" ]; then
      setOpenFOAMEnv
    fi

    cd $WM_PROJECT_DIR
    BUILD_AWOPENFOAMDOC_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/docmake.log"

    #set up traps...
    trap build_awopenfoam_docs_ctrl_c_triggered SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build OpenFOAM code documentation:"
    echo "Calculating building estimates, please wait..."
    #first calculate estimate
    BUILD_AWOPENFOAMDOC_FILECOUNT=`find * | grep -v "/lnInclude/" | grep -v "/t/" | grep -e "^src/" -e "^applications/utilities" -e "^applications/solvers" | grep -e ".H$" -e ".C$" | wc -l`
    BUILD_AWOPENFOAMDOC_ESTIMCOUNT=`expr $BUILD_AWOPENFOAMDOC_FILECOUNT \* 385 / 100` #it's an empirical estimate based on some runs
    echo "Now it's going to build the documentation..."

    #launch wmake all asynchronously
    cd doc
    bash -c "time wmake all > ${BUILD_AWOPENFOAMDOC_LOG} 2>&1" >> ${BUILD_AWOPENFOAMDOC_LOG} 2>&1 &
    BUILD_AWOPENFOAM_PID=$!
    BUILD_AWOPENFOAMDOC_START_TIME=`date`
    BUILD_AWOPENFOAM_UPDATE_TIME=$BUILD_AWOPENFOAMDOC_START_TIME
    cd ..
    echo "------------------------------------------------------"

    #track build progress
    percent=0
    build_awopenfoam_docs_progress_dialog

    #wait for kill code to change
    clear
    if ! ps -p $BUILD_AWOPENFOAM_PID > /dev/null && [ "x$BUILD_AWOPENFOAM_MUST_KILL" != "x" ]; then
      echo "Kill code issued with success. The script will continue execution."
    fi

    #clear traps
    trap - SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build OpenFOAM:"
    echo -e "Doxygen started to build at:\n\t$BUILD_AWOPENFOAMDOC_START_TIME\n"
    echo -e "Doxygen finished at:\n\t`date`"
    echo "------------------------------------------------------"

  fi
}

function continue_after_failed_openfoam()
{
  if [ "x$FOAMINSTALLFAILED" != "x" ]; then
    FOAMINSTALLFAILED_BUTCONT="No"
    echo -e "\n------------------------------------------------------\n"
    echo "Although the previous step seems to have failed, do you wish to continue with the remaining steps?"

    if [ "x$BUILD_DOCUMENTATION" == "xon" -o "x$BUILD_CCM26TOFOAM" == "xon" -o \
         "x$BUILD_PARAVIEW" == "xon" -o "x$BUILD_QT" == "xon" ]; then
      echo "Missing steps are:"
      if [ "x$BUILD_DOCUMENTATION" == "xon" ]; then echo "- Building OpenFOAM's code documentation"; fi
      if [ "x$BUILD_QT" == "xon" ]; then echo "- Building Qt"; fi
      if [ "x$BUILD_PARAVIEW" == "xon" ]; then echo "- Building ParaView"; fi
      if [ "x$BUILD_CCM26TOFOAM" == "xon" ]; then echo "- Building ccm26ToFoam"; fi
    fi

    echo "Continue? (yes or no): "
    read casestat;
    case $casestat in
      yes | y | Y | Yes | YES) FOAMINSTALLFAILED_BUTCONT="Yes";;
    esac
    unset casestat
    echo "------------------------------------------------------"
  fi
}

function continue_after_failed_openfoam_git()
{
  if [ "x$OpenFOAM_git_error" != "x0" ]; then
    echo -e "\n------------------------------------------------------\n"
    echo "The previous git operation failed, which without it continuing this script may be useless."
    echo "But do you wish continue nonetheless? (yes or no): "
    read casestat;
    case $casestat in
      no | n | N | No | NO) exit 0;;
    esac
    unset casestat
    echo "------------------------------------------------------"
  fi
}

#check if the installation is complete
function check_installation()
{
  #set up environment, just in case we forget about it!
  if [ "x$WM_PROJECT_DIR" == "x" ]; then
    setOpenFOAMEnv
  fi

  cd $WM_PROJECT_DIR

  FOAM_INSTALLATION_TEST_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/foamIT.log"

  echo "------------------------------------------------------"
  echo "Checking installation - you should see NO criticals..."
  echo "------------------------------------------------------"
  foamInstallationTest | tee "$FOAM_INSTALLATION_TEST_LOG"
  echo -e "\n\nThis report has been saved in file $FOAM_INSTALLATION_TEST_LOG"

  #if issues found then generate "bug report" and request that the user reports it!
  IFERRORSDETECTED=`grep "Critical systems ok" "$FOAM_INSTALLATION_TEST_LOG"`
  if [ "x$IFERRORSDETECTED" == "x" ]; then
    FOAMINSTALLFAILED="Yes"
    echo -e "\nSadly there have been some critical issues detected by OpenFOAM's foamInstallationTest script."
    echo "A full report file can be generated so you can post it at this forum thread:"
    echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
    echo -e '\nYou can also verify the thread for other people who might have had the same problems.'
    echo "So, do you want to generate a report file for attaching to your post? (yes or no): "
    read casestat;
    case $casestat in
      yes | y | Y | Yes | YES)
        FILES_TO_REPORT="$FOAM_INSTALLATION_TEST_LOG $BUILD_AWOPENFOAM_LOG"
        if [ "x$LOG_OUTPUTS" == "xYes" ]; then
          FILES_TO_REPORT="$FILES_TO_REPORT $LOG_OUTPUTS_FILE_LOCATION"
        fi
        echo "Compressing file $WM_PROJECT_DIR/report.tar.gz with files: $FILES_TO_REPORT"
        if [ -e "report.tar.gz" ]; then rm -f report.tar.gz; fi
        tar -czf report.tar.gz $FILES_TO_REPORT
        echo "Compression complete. Please attach this file to your report about the bad installation."
        unset FILES_TO_REPORT
        ;;
    esac
    unset casestat

    continue_after_failed_openfoam
  fi
  unset IFERRORSDETECTED
}

function fix_tutorials()
{
  #fix tutorials, if sh isn't linked to bash
  if is_sh_bash; then
    #set up environment, just in case we forget about it!
    if [ "x$FOAM_TUTORIALS" == "x" ]; then
      setOpenFOAMEnv
    fi

    cd $WM_PROJECT_DIR

    echo "------------------------------------------------------"
    echo "Fixing call for bash in tutorials (sometimes the default is dash, like in Ubuntu)"
    #NOTE: searching for patterns requires quotes
    find $FOAM_TUTORIALS/ -name "All*" -name "makeMesh" | \
    while read file
    do
        mv "$file" "$file.old"
        sed '/^#!/ s/\/bin\/sh/\/bin\/bash/' "$file.old" > "$file"
        rm -f "$file.old"
    done
    echo "Fix up bash done"
    echo "------------------------------------------------------"
  fi
}

#final messages and instructions for when we do a clean install...
#whether it goes well or not
function final_messages_for_clean_install()
{
  echo "------------------------------------------------------"
  if [ "x$FOAMINSTALLFAILED" == "x" ]; then

    #If using bash alias, inform to use it to run!
    if [ "x$USE_ALIAS_FOR_BASHRC" == "xon" ]; then
      echo "Installation complete - You have chosen to use bash alias"
      echo "To start using OpenFOAM, you'll have to start a new terminal first;"
      echo -e "then, type:\n\tstartFoam$OF_SHORT_VERSION\nto activate the OpenFOAM environment."
      echo "------------------------------------------------------"
    else
      echo "Installation complete"
      echo "To start using OpenFOAM, you'll have to start a new terminal first."
      echo "------------------------------------------------------"
    fi

  else

    echo "Installation failed. Please don't forget to check the provided forum link for solutions on the provided link, and/or report the error."
    if [ "x$USE_ALIAS_FOR_BASHRC" == "xon" ]; then
      echo "Nonetheless, next time you launch a new terminal/console, you can set up the OpenFOAM environment by typing: startFoam$OF_SHORT_VERSION"
    else
      echo "Nonetheless, next time you launch a new terminal/console, the OpenFOAM environment will be ready to be used."
    fi
    echo "------------------------------------------------------"

  fi
}

function OpenFOAM_git_pull()
{
  #set up environment, just in case we forget about it!
  if [ "x$WM_PROJECT_DIR" == "x" ]; then
    setOpenFOAMEnv
  fi

  cd $WM_PROJECT_DIR

  echo "------------------------------------------------------"
  echo "Let's do a git pull"
  echo "------------------------------------------------------"
  git pull
  OpenFOAM_git_error=$?

  continue_after_failed_openfoam_git
}

#provide the user with a progress bar and timings for building Qt
function build_Qt_progress_dialog()
{
  if [ "x$BUILD_QT_MUST_KILL" == "xYes" ]; then
    echo -e "\n\nKill code issued... please wait..."
    echo -e "NOTE: The kill code will take a few seconds to affect all child processes."
    killgroup $BUILD_QT_PID

  else

    ( #while true is used as a containment cycle...
    while : ;
    do
      if [ -e "$BUILD_QT_LOG" ]; then
        BUILD_QT_MAKECOUNT=`grep 'make\[.\]' "$BUILD_QT_LOG" | wc -l`
        nowpercent=`expr $BUILD_QT_MAKECOUNT \* 100 / $BUILD_QT_LAST_BUILD_COUNT`
      fi
      if [ "x$nowpercent" != "x$percent" ]; then
        percent=$nowpercent
        BUILD_QT_UPDATE_TIME=`date`
      fi
      echo $percent
      echo "XXX"
      echo "Build Qt ${QT_VERSION}:"
      echo "The build process is going to be logged in the file:"
      echo "  $BUILD_QT_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $BUILD_QT_LOG"
      echo "Either way, please wait, this will take a while..."
      echo -e "\nQt started to build at:\n\t$BUILD_QT_START_TIME\n"
      echo -e "Last progress update made at:\n\t$BUILD_QT_UPDATE_TIME"
      echo "XXX"

      #this provides a better monitorization of the process itself... i.e., if it has already stopped!
      #30 second update
      monitor_sleep $BUILD_QT_PID 30

      if ! ps -p $BUILD_QT_PID > /dev/null; then
        break;
      fi
    done
    ) | dialog --backtitle "$GUI_BACKTITLE" \
        --title "Building Qt" --gauge "Starting..." 20 80 $percent >&4

  fi

  #monitor here too, to wait for kill code, when issued
  monitor_sleep $BUILD_QT_PID 30
}

#this indicates to the user that we have it under control...
function build_Qt_ctrl_c_triggered()
{
  BUILD_QT_MUST_KILL="Yes"
  build_Qt_progress_dialog
}

function build_Qt()
{
  if [ "x$BUILD_QT" == "xon" ]; then
    #set up environment, just in case we forget about it!
    if [ "x$WM_PROJECT_DIR" == "x" ]; then
      setOpenFOAMEnv
    fi

    cd $WM_THIRD_PARTY_DIR

    #set the QT_PLATFORM_PATH variable, since it depends on the OpenFOAM version
    set_QT_PLATFORM_PATH

    #purge existing Qt
    if [ -e "$QT_PLATFORM_PATH" ]; then
      rm -rf $QT_PLATFORM_PATH
    fi

    BUILD_QT_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/build_Qt.log"

    #set up traps...
    trap build_Qt_ctrl_c_triggered SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build Qt:"

    #launch makeQt asynchronously
    bash -c "time ./makeQt --confirm-license=yes" > "$BUILD_QT_LOG" 2>&1 &
    BUILD_QT_PID=$!
    BUILD_QT_START_TIME=`date`
    BUILD_QT_UPDATE_TIME=$BUILD_QT_START_TIME

    #track build progress
    percent=0
    build_Qt_progress_dialog

    #wait for kill code to change
    clear
    if ! ps -p $BUILD_QT_PID > /dev/null && [ "x$BUILD_QT_MUST_KILL" != "x" ]; then
      echo "Kill code issued with success. The script will continue execution."
    fi

    #clear traps
    trap - SIGINT SIGQUIT SIGTERM

    echo "------------------------------------------------------"
    echo "Build Qt ${QT_VERSION}:"
    if [ -e "$QT_PLATFORM_PATH/bin/qmake" ]; then
      echo -e "Qt started to build at:\n\t$BUILD_QT_START_TIME\n"
      echo -e "Building Qt finished successfully at:\n\t`date`"
      echo "Qt is ready to use for building ParaView."
    else
      echo "Build process didn't finished with success. Please check the log file for more information:"
      echo -e "\t$BUILD_QT_LOG"
      echo "You can post it at this forum thread:"
      echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
      echo -e '\nYou can also verify that thread for other people who might have had the same problems.'
      BUILDING_QT_FAILED="Yes"
    fi
    echo "------------------------------------------------------"

  fi
}

#provide the user with a progress bar and timings for building ParaView
function build_ParaView_progress_dialog()
{
  if [ "x$BUILD_PARAVIEW_MUST_KILL" == "xYes" ]; then
    echo -e "\n\nKill code issued... please wait..."
    echo -e "NOTE: The kill code will take a few seconds to affect all child processes."
    killgroup $BUILD_PARAVIEW_PID

  else
    ( #while true is used as a containment cycle...
    while : ;
    do
      #get progress value
      if [ -e "$PARAVIEW_BUILD_LOG" ]; then
        BUILD_PARAVIEW_PROGRESS=`cat "$PARAVIEW_BUILD_LOG" | grep "^\[" | tail -n 1 | sed 's/^\[\([ 0-9]*\).*/\1/' | sed 's/\ *//'`
      fi
      if [ "x$BUILD_PARAVIEW_PROGRESS" != "x" -a "x$BUILD_PARAVIEW_PROGRESS" != "x$percent" ]; then
        percent=$BUILD_PARAVIEW_PROGRESS
        BUILD_PARAVIEW_UPDATE_TIME=`date`
      fi

      #get current build stage
      BUILD_PARAVIEW_ISNOWATDOC=`cat "$PARAVIEW_BUILD_LOG" | grep "Creating html documentation" | wc -l`
      BUILD_PARAVIEW_ISNOWFINALIZING=`cat "$PARAVIEW_BUILD_LOG" | grep "Replacing path hard links for" | wc -l`

      echo $percent
      echo "XXX"
      echo "Build ParaView:"
      echo "The build process is going to be logged in the file:"
      echo "  $PARAVIEW_BUILD_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $PARAVIEW_BUILD_LOG"
      echo "Either way, please wait, this will take a while..."
      echo -e "\nParaView started to build at:\n\t$BUILD_PARAVIEW_START_TIME\n"
      echo -e "Last progress update made at:\n\t$BUILD_PARAVIEW_UPDATE_TIME\n"

      if [ "x$BUILD_PARAVIEW_ISNOWATDOC" != "x0" -a "x$BUILD_PARAVIEW_ISNOWFINALIZING" == "x0" ]; then
        echo "Building HTML documentation for ParaView..."
      elif [ "x$BUILD_PARAVIEW_ISNOWFINALIZING" != "x0" ]; then
        echo "Finalizing... almost complete..."
      fi

      echo "XXX"

      #this provides a better monitorization of the process itself... i.e., if it has already stopped!
      #30 second update
      monitor_sleep $BUILD_PARAVIEW_PID 30

      if ! ps -p $BUILD_PARAVIEW_PID > /dev/null; then
        break;
      fi
    done
    ) | dialog --backtitle "$GUI_BACKTITLE" \
        --title "Building ParaView" --gauge "Starting..." 20 80 $percent >&4

  fi

  #monitor here too, to wait for kill code, when issued
  monitor_sleep $BUILD_PARAVIEW_PID 30
}

#this indicates to the user that we have it under control...
function build_ParaView_ctrl_c_triggered()
{
  BUILD_PARAVIEW_MUST_KILL="Yes"
  build_ParaView_progress_dialog
}

function hookup_Qt_Libs_with_ParaView()
{
  if [ "x$BUILD_QT" == "xon" ]; then
    for a in ${QT_PLATFORM_PATH}/lib/*.4; do
      b=`echo $a | sed -e 's/.*\/\(.*\)$/\1/'`
      ln -s $a ${ParaView_DIR}/bin/$b
    done
  fi
}

function build_ParaView()
{
  if [ "x$BUILD_PARAVIEW" == "xon" ]; then

    if [ "x$BUILD_QT" == "xon" -a "x$BUILDING_QT_FAILED" == "xYes" ]; then

      echo "------------------------------------------------------"
      echo "The requested Qt is unavailable, thus rendering impossible to build ParaView with it."
      echo "------------------------------------------------------"

    else

      #set up environment, just in case we forget about it!
      if [ "x$WM_PROJECT_DIR" == "x" ]; then
        setOpenFOAMEnv
      fi

      cd $WM_THIRD_PARTY_DIR

      #purge existing ParaView
      if [ -e "$ParaView_DIR" ]; then
        rm -rf $ParaView_DIR
      fi

      PARAVIEW_BUILD_OPTIONS=""
      if [ "x$BUILD_QT" == "xon" ]; then
        PARAVIEW_BUILD_OPTIONS="$PARAVIEW_BUILD_OPTIONS -qmake \"$QT_PLATFORM_PATH/bin/qmake\""
      fi

      if [ "x$BUILD_PARAVIEW_WITH_GUI" == "xoff" ]; then
        PARAVIEW_BUILD_OPTIONS="$PARAVIEW_BUILD_OPTIONS -noqt"
      fi

      if [ "x$BUILD_PARAVIEW_WITH_MPI" == "xon" ]; then
        PARAVIEW_BUILD_OPTIONS="$PARAVIEW_BUILD_OPTIONS -mpi"
      fi

      if [ "x$BUILD_PARAVIEW_WITH_PYTHON" == "xon" ]; then
        PARAVIEW_BUILD_OPTIONS="$PARAVIEW_BUILD_OPTIONS -python"
      fi

      if [ "x$BUILD_PARAVIEW_WITH_OSMESA" == "xon" ]; then
        PARAVIEW_BUILD_OPTIONS="$PARAVIEW_BUILD_OPTIONS -mesa"
      fi

      PARAVIEW_BUILD_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/build_ParaView.log"

      #set up traps...
      trap build_ParaView_ctrl_c_triggered SIGINT SIGQUIT SIGTERM

      echo "------------------------------------------------------"
      echo "Build ParaView:"

      #launch makeParaView asynchronously
      bash -c "time ./makeParaView $PARAVIEW_BUILD_OPTIONS" > "$PARAVIEW_BUILD_LOG" 2>&1 &
      BUILD_PARAVIEW_PID=$!
      BUILD_PARAVIEW_START_TIME=`date`
      BUILD_PARAVIEW_UPDATE_TIME=$BUILD_PARAVIEW_START_TIME

      #track build progress
      percent=0
      build_ParaView_progress_dialog

      #wait for kill code to change
      clear
      if ! ps -p $BUILD_PARAVIEW_PID > /dev/null && [ "x$BUILD_PARAVIEW_MUST_KILL" != "x" ]; then
        echo "Kill code issued with success. The script will continue execution."
      fi

      #clear traps
      trap - SIGINT SIGQUIT SIGTERM

      echo "------------------------------------------------------"
      echo "Build ParaView:"
      if [ -e "$ParaView_DIR/bin/paraview" ]; then

        #this will make links in ParaView's bin folder to the custom build of Qt's libraries
        hookup_Qt_Libs_with_ParaView

        echo -e "ParaView started to build at:\n\t$BUILD_PARAVIEW_START_TIME\n"
        echo -e "Building ParaView finished successfully at:\n\t`date`"
        echo "ParaView is ready to use."

      elif [ "x$BUILD_PARAVIEW_WITH_GUI" == "xoff" -a "x$BUILD_PARAVIEW_WITH_MPI" == "xon" -a \
             -e "$ParaView_DIR/bin/pvserver" -a -e "$ParaView_DIR/bin/pvrenderserver" -a \
             -e "$ParaView_DIR/bin/pvdataserver" ]; then

        #this will make links in ParaView's bin folder to the custom build of Qt's libraries
        hookup_Qt_Libs_with_ParaView

        echo -e "ParaView started to build at:\n\t$BUILD_PARAVIEW_START_TIME\n"
        echo -e "Building ParaView finished successfully at:\n\t`date`"
        echo "ParaView server tools are ready to be used."

      else

        echo "Build process didn't finished with success. Please check the log file for more information:"
        echo -e "\t$PARAVIEW_BUILD_LOG"
        echo "You can post it at this forum thread:"
        echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
        echo -e '\nYou can also verify that thread for other people who might have had the same problems.'
        BUILDING_PARAVIEW_FAILED="Yes"
        #TODO: do something more with BUILDING_PARAVIEW_FAILED, like final error listing and suggestions
      fi
      echo "------------------------------------------------------"

    fi
  fi
}

function build_PV3FoamReader()
{
  if [ "x$BUILD_PARAVIEW" == "xon" ]; then

    #set up environment, just in case we forget about it!
    if [ "x$WM_PROJECT_DIR" == "x" ]; then
      setOpenFOAMEnv
    fi

    if [ "x$BUILD_QT" == "xon" -a "x$BUILDING_QT_FAILED" == "xYes" ]; then

      echo "------------------------------------------------------"
      echo "No Qt, no ParaView, thus no PV3FoamReader."
      echo "------------------------------------------------------"

    elif [ ! -e "$ParaView_DIR/bin/paraview" ]; then

      echo "------------------------------------------------------"
      echo "ParaView isn't available where it is expected:"
      echo "  $ParaView_DIR/bin/paraview"
      echo "Therefore it isn't possible to proceed with building the plugin PV3FoamReader."
      echo "------------------------------------------------------"

    else

      cd "$FOAM_UTILITIES/postProcessing/graphics/PV3FoamReader"

      PV3FOAMREADER_BUILD_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/build_PV3FoamReader.log"

      echo "------------------------------------------------------"
      echo "Build PV3FoamReader for ParaView:"
      echo "The build process is going to be logged in the file:"
      echo "  $PV3FOAMREADER_BUILD_LOG"
      echo "If you want to, you can follow the progress of this build"
      echo "process, by opening a new terminal and running:"
      echo "  tail -F $PV3FOAMREADER_BUILD_LOG"
      echo "Either way, please wait, this will take a while..."

      bash -c "time ./Allwclean" > "$PV3FOAMREADER_BUILD_LOG" 2>&1
      echo -e "\n\n" >> "$PV3FOAMREADER_BUILD_LOG"
      export WM_DO_TIMINGS="Yes"
      bash -c "time wmake all" >> "$PV3FOAMREADER_BUILD_LOG" 2>&1
      export WM_DO_TIMINGS=

      if [ -e "$FOAM_LIBBIN/libvtkPV3Foam.so" -a -e "$FOAM_LIBBIN/libPV3FoamReader.so" -a -e "$FOAM_LIBBIN/libPV3FoamReader_SM.so" ]; then
        echo "Build process finished successfully: paraFoam is ready to use."
      else
        echo "Build process didn't finished with success. Please check the log file for more information:"
        echo -e "\t$PV3FOAMREADER_BUILD_LOG"
        echo "You can post it at this forum thread:"
        echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
        echo -e '\nYou can also verify that thread for other people who might have had the same problems.'
        PV3FOAMREADERFAILED="Yes"
        #TODO: do something with PV3FOAMREADERFAILED
      fi
      echo "------------------------------------------------------"
    fi
  fi
}

function build_ccm26ToFoam()
{

  if [ "x$BUILD_CCM26TOFOAM" == "xon" ]; then
    #set up environment, just in case we forget about it!
    if [ "x$WM_PROJECT_DIR" == "x" ]; then
      setOpenFOAMEnv
    fi

    cd "$FOAM_APP/utilities/mesh/conversion/Optional/"

    BUILD_CCM26TOFOAM_LOG="$BASE_LOG_FOLDER/$OF_SHORT_VERSION/build_ccm26.log"

    echo "------------------------------------------------------"
    echo "Build ccm26ToFoam:"
    echo "This will also build the libccmio library, which requires "
    echo "specify downloading of the files for it."
    echo "The build process is going to be logged in the file:"
    echo "  $BUILD_CCM26TOFOAM_LOG"
    echo "If you want to, you can follow the progress of this build"
    echo "process, by opening a new terminal and running:"
    echo "  tail -F $BUILD_CCM26TOFOAM_LOG"
    echo "Either way, please wait, this will take a while..."

    export WM_DO_TIMINGS="Yes"
    bash -c "time wmake all" > "$BUILD_CCM26TOFOAM_LOG" 2>&1
    export WM_DO_TIMINGS=

    if [ -e "$FOAM_APPBIN/ccm26ToFoam" ]; then
      echo "Build process finished successfully: ccm26ToFoam is ready to use."
    else
      echo "Build process didn't finished with success. Please check the log file for more information:"
      echo -e "\t$BUILD_CCM26TOFOAM_LOG"
      echo "You can post it at this forum thread:"
      echo "  http://www.cfd-online.com/Forums/openfoam-installation/73805-openfoam-1-6-x-installer-ubuntu.html"
      echo -e '\nYou can also verify that thread for other people who might have had the same problems.'
      CCM26INSTALLFAILED="Yes"
      #TODO: do something with CCM26INSTALLFAILED
    fi
    echo "------------------------------------------------------"
  fi
}
